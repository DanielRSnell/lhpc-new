---
export const prerender = true;
import { getCollection } from 'astro:content';

import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';

import { Button } from '@/components/ui/button';
import DefaultLayout from '@/layouts/DefaultLayout.astro';
import { cn } from '@/lib/utils';

// Get all event entries, sorted by date (descending for newest first)
const eventEntries = await getCollection('events');
const sortedEntries = eventEntries.sort((a, b) => {
  // Parse dates for proper chronological sorting
  const dateA = new Date(a.data.date);
  const dateB = new Date(b.data.date);
  return dateB.getTime() - dateA.getTime(); // Descending order for newest first
});

// Prepare entries with excerpts
const entriesWithExcerpts = sortedEntries.map((entry) => {
  // Use frontmatter excerpt if provided, otherwise extract from body
  const excerpt = entry.data.excerpt || entry.body.substring(0, 200) + '...';

  return {
    ...entry,
    excerpt,
  };
});

// Determine if we should show "Load more" button
const hasMultipleEntries = entriesWithExcerpts.length > 1;
---

<DefaultLayout
  title="Events - Amalgamy"
  description="Join us at upcoming conferences and industry events"
>
  <section class="section-padding container max-w-5xl space-y-24">
    <!-- Header -->
    <div class="flex flex-wrap items-center justify-between gap-10">
      <div class="space-y-3">
        <h1 class="text-4xxl leading-tight font-medium tracking-tight">
          Events
        </h1>
        <p class="text-muted-foreground text-lg leading-snug">
          Join us at upcoming conferences and industry events
        </p>
      </div>
    </div>

    <div class="[--sidebar-width:150px]">
      <!-- Event entries with timeline -->
      <div class="relative">
        {
          entriesWithExcerpts.map((entry, index) => (
            <div class="flex gap-5 md:gap-12">
              {/* Date column with dot */}
              <div class="relative mt-0.5 shrink-0 md:mt-1.5 md:w-[var(--sidebar-width)]">
                <time class="text-muted-foreground hidden md:inline-block">
                  {entry.data.date}
                </time>
                <div class="bg-background border-input absolute top-0 right-0 z-10 grid size-5 translate-x-1/2 place-items-center rounded-full border">
                  <div class="bg-secondary size-2 rounded-full" />
                </div>
                <div class="absolute top-0 right-0 h-full w-0.25 bg-[repeating-linear-gradient(to_bottom,var(--input)_0px,var(--input)_8px,transparent_12px,transparent_20px)]" />
              </div>

              {/* Content */}
              <div
                class={cn(
                  'mb-16 flex-1',
                  index === entriesWithExcerpts.length - 1 && 'mb-0',
                )}
              >
                <time class="text-muted-foreground mb-10 inline-block md:hidden">
                  {entry.data.date}
                </time>
                <h2 class="text-2xl leading-tight font-medium">
                  <a
                    href={entry.data.event_url}
                    class="hover:text-secondary transition-colors"
                  >
                    {entry.data.title}
                  </a>
                </h2>

                {/* Location */}
                <p class="text-muted-foreground mt-2 text-sm font-medium">
                  ğŸ“ {entry.data.location}
                </p>

                {/* Featured Image */}
                {entry.data.featured_image && (
                  <div class="mt-6">
                    <a href={entry.data.event_url} class="block">
                      <div class="aspect-video overflow-hidden rounded-lg border shadow-sm transition-shadow hover:shadow-md">
                        <img
                          src={entry.data.featured_image}
                          alt={entry.data.title}
                          class="h-full w-full object-cover"
                        />
                      </div>
                    </a>
                  </div>
                )}

                {/* Event Excerpt */}
                <p class="text-muted-foreground mt-4 text-base leading-relaxed md:text-lg">
                  {entry.excerpt}
                </p>

                {/* View Event Link */}
                <div class="mt-6">
                  <a
                    href={entry.data.event_url}
                    class="hover:text-secondary inline-flex items-center gap-2 text-sm font-medium underline transition-colors"
                  >
                    View event details
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M5 12h14"></path>
                      <path d="m12 5 7 7-7 7"></path>
                    </svg>
                  </a>
                </div>
              </div>
            </div>
          ))
        }
      </div>

      {hasMultipleEntries && (
        <div class="flex justify-end">
          <Button
            variant="secondary"
            className="mt-25 h-12 w-full md:w-[calc(100%-var(--sidebar-width))]"
            client:load
          >
            Load more
          </Button>
        </div>
      )}

    </div>
  </section>

</DefaultLayout>
